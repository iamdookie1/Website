<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Audio Editor</title>
<style>
:root {
    --bg: radial-gradient(circle at top, #1b1b1b, #000);
    --gold: #d4af37;
    --panel: rgba(18,18,18,0.92);
    --muted: #888;
    --text: #f2f2f2;
}
* { box-sizing: border-box; }
body {
    margin: 0;
    min-height: 100vh;
    background: var(--bg);
    font-family: system-ui, sans-serif;
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: center;
}
.container {
    width: 100%;
    max-width: 760px;
    padding: 40px;
}
.panel {
    background: var(--panel);
    border: 1px solid rgba(212,175,55,0.2);
    border-radius: 16px;
    padding: 28px;
    box-shadow: 0 0 50px rgba(212,175,55,0.08);
}
.panel + .panel { margin-top: 24px; }
h1 {
    margin: 0 0 20px;
    text-align: center;
    color: var(--gold);
    font-size: 26px;
}
.import {
    border: 2px dashed rgba(212,175,55,0.3);
    padding: 40px;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
}
.import input { display: none; }
.controls, .advanced { display: none; }
.row { margin-bottom: 16px; }
label { font-size: 13px; color: var(--muted); }
input[type=range] { width: 100%; }
button {
    padding: 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
}
.primary {
    background: linear-gradient(135deg,#b8962e,#f0d57a);
    color: #000;
}
.secondary {
    background: transparent;
    border: 1px solid rgba(212,175,55,0.3);
    color: var(--gold);
}
.buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.segment {
    border: 1px solid rgba(212,175,55,0.25);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
}
.segment-controls {
    display: flex;
    gap: 6px;
    margin-top: 8px;
}
.small {
    flex: 1;
    padding: 6px;
    font-size: 12px;
}
</style>
</head>
<body>
<div class="container">

<div class="panel">
    <h1>Import File</h1>
    <label class="import">
        <input type="file" id="fileInput" accept="audio/*">
        Click to import audio
    </label>
</div>

<div class="panel controls" id="basic">
    <h1>Editor</h1>

    <div class="row">
        <label>Start</label>
        <input type="range" id="start" step="0.01">
    </div>

    <div class="row">
        <label>End</label>
        <input type="range" id="end" step="0.01">
    </div>

    <div class="row">
        <label>Playback Speed</label>
        <input type="range" id="speed" min="0.5" max="2" step="0.01" value="1">
    </div>

    <div class="row">
        <label><input type="checkbox" id="loop"> Loop Preview</label>
    </div>

    <div class="buttons">
        <button class="primary" id="play">Play</button>
        <button class="secondary" id="stop">Stop</button>
        <button class="secondary" id="addSegment">Add Section</button>
        <button class="secondary" id="toggleAdvanced">Advanced</button>
        <button class="primary" id="download">Download</button>
    </div>
</div>

<div class="panel advanced" id="advanced">
    <h1>Advanced Sections</h1>
    <div id="segments"></div>
</div>

</div>

<script>
let ctx, buffer, source;
let segments = [];

const fileInput = document.getElementById("fileInput");
const basic = document.getElementById("basic");
const advanced = document.getElementById("advanced");
const start = document.getElementById("start");
const end = document.getElementById("end");
const speed = document.getElementById("speed");
const loop = document.getElementById("loop");

fileInput.onchange = async e => {
    const file = e.target.files[0];
    ctx = new AudioContext();
    buffer = await ctx.decodeAudioData(await file.arrayBuffer());
    start.max = end.max = buffer.duration;
    end.value = buffer.duration;
    basic.style.display = "block";
};

function stopAudio() {
    if (source) {
        source.stop();
        source.disconnect();
        source = null;
    }
}

document.getElementById("play").onclick = () => {
    stopAudio();
    source = ctx.createBufferSource();
    source.buffer = buffer;
    source.playbackRate.value = speed.value;
    source.loop = loop.checked;
    source.connect(ctx.destination);
    source.start(0, start.value, end.value - start.value);
};

document.getElementById("stop").onclick = stopAudio;

document.getElementById("addSegment").onclick = () => {
    segments.push({
        start: Number(start.value),
        end: Number(end.value),
        fadeIn: 0,
        fadeOut: 0
    });
    renderSegments();
};

document.getElementById("toggleAdvanced").onclick = () => {
    advanced.style.display = advanced.style.display === "block" ? "none" : "block";
};

function renderSegments() {
    const container = document.getElementById("segments");
    container.innerHTML = "";
    segments.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "segment";
        div.innerHTML = `
            Section ${i + 1}<br>
            Start: ${s.start.toFixed(2)}s | End: ${s.end.toFixed(2)}s
            <div class="segment-controls">
                <button class="secondary small" onclick="move(${i},-1)">↑</button>
                <button class="secondary small" onclick="move(${i},1)">↓</button>
                <button class="secondary small" onclick="removeSeg(${i})">✕</button>
            </div>
        `;
        container.appendChild(div);
    });
}

window.move = (i,d) => {
    const j = i + d;
    if (j < 0 || j >= segments.length) return;
    [segments[i], segments[j]] = [segments[j], segments[i]];
    renderSegments();
};

window.removeSeg = i => {
    segments.splice(i,1);
    renderSegments();
};

document.getElementById("download").onclick = async () => {
    if (!segments.length) segments.push({start:+start.value,end:+end.value});
    let total = segments.reduce((a,s)=>a+(s.end-s.start),0);
    const off = new OfflineAudioContext(
        buffer.numberOfChannels,
        total * buffer.sampleRate,
        buffer.sampleRate
    );
    let t = 0;
    segments.forEach(s => {
        const src = off.createBufferSource();
        src.buffer = buffer;
        src.connect(off.destination);
        src.start(t, s.start, s.end - s.start);
        t += s.end - s.start;
    });
    const rendered = await off.startRendering();
    const wav = encode(rendered);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([wav],{type:"audio/wav"}));
    a.download = "edited.wav";
    a.click();
};

function encode(b){
    const l=b.length*2*b.numberOfChannels+44;
    const v=new DataView(new ArrayBuffer(l));
    let o=0;
    const w=s=>{for(let i=0;i<s.length;i++)v.setUint8(o++,s.charCodeAt(i));};
    const u16=d=>{v.setUint16(o,d,true);o+=2;};
    const u32=d=>{v.setUint32(o,d,true);o+=4;};
    w("RIFF");u32(l-8);w("WAVEfmt ");u32(16);u16(1);
    u16(b.numberOfChannels);u32(b.sampleRate);
    u32(b.sampleRate*b.numberOfChannels*2);
    u16(b.numberOfChannels*2);u16(16);w("data");u32(l-o-4);
    for(let i=0;i<b.length;i++)
        for(let c=0;c<b.numberOfChannels;c++){
            let s=b.getChannelData(c)[i];
            s=Math.max(-1,Math.min(1,s));
            v.setInt16(o,s*32767,true);o+=2;
        }
    return v.buffer;
}
</script>
</body>
</html>
