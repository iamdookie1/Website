<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Audio Editor</title>

<style>
:root{
--bg:radial-gradient(circle at top,#1c1c1c,#000);
--gold:#d4af37;
--panel:rgba(18,18,18,.95);
--text:#f3f3f3;
--muted:#9a9a9a;
}
*{box-sizing:border-box}
body{
margin:0;
min-height:100vh;
background:var(--bg);
font-family:system-ui,sans-serif;
color:var(--text);
}
.wrapper{max-width:1200px;margin:auto;padding:40px}
.panel{
background:var(--panel);
border:1px solid rgba(212,175,55,.25);
border-radius:18px;
padding:28px;
margin-bottom:28px;
}
h1{text-align:center;color:var(--gold)}
.import{
border:2px dashed rgba(212,175,55,.35);
padding:50px;
border-radius:14px;
text-align:center;
cursor:pointer
}
.import input{display:none}
.controls,.advanced{display:none}
.row{margin-bottom:18px}
label{display:flex;justify-content:space-between;color:var(--muted)}
input[type=range]{width:100%}
.buttons{display:flex;gap:12px;flex-wrap:wrap}
button{
padding:14px;
border-radius:12px;
border:none;
font-weight:600;
cursor:pointer
}
.primary{background:linear-gradient(135deg,#b8962e,#f0d57a);color:#000}
.secondary{
background:transparent;
border:1px solid rgba(212,175,55,.35);
color:var(--gold)
}
.segment{
border:1px solid rgba(212,175,55,.35);
border-radius:12px;
padding:14px;
margin-bottom:14px
}
.segment.min .body{display:none}
.segment header{
display:flex;
justify-content:space-between;
align-items:center
}
small{color:var(--muted)}
select{
background:#000;
color:var(--text);
border:1px solid rgba(212,175,55,.3);
border-radius:6px;
padding:6px
}

/* hamburger */
.hamburger{
position:fixed;
top:18px;
right:18px;
width:26px;
cursor:pointer;
z-index:1000
}
.hamburger span{
display:block;
height:3px;
background:var(--gold);
margin:5px 0
}

/* side menu */
.side{
position:fixed;
top:0;
right:-320px;
width:300px;
height:100%;
background:#0e0e0e;
border-left:1px solid rgba(212,175,55,.3);
padding:20px;
transition:.3s;
z-index:999
}
.side.open{right:0}
.side h2{color:var(--gold)}
.side button{width:100%;margin-bottom:10px}

/* dialog */
.dialog{
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
display:none;
align-items:center;
justify-content:center;
z-index:2000
}
.dialog .box{
background:#111;
border:1px solid rgba(212,175,55,.4);
border-radius:16px;
padding:24px;
width:320px
}
.dialog button{width:100%;margin-top:10px}
</style>
</head>
<body>

<div class="hamburger" onclick="toggleSide()">
<span></span><span></span><span></span>
</div>

<div class="side" id="side">
<h2>Menu</h2>
<button class="secondary" onclick="openLoad()">Load Saves</button>
<button class="secondary" onclick="saveProject()">Save</button>
<button class="secondary" onclick="toggleSide()">Close</button>
</div>

<div class="wrapper">

<div class="panel">
<h1>Import File</h1>
<label class="import">
<input type="file" id="file" accept="audio/*">
Click to import audio
</label>
</div>

<div class="panel controls" id="editor">
<h1>Editor</h1>

<div class="row">
<label>Start <span id="sv"></span></label>
<input type="range" id="start" step="0.01">
</div>

<div class="row">
<label>End <span id="ev"></span></label>
<input type="range" id="end" step="0.01">
</div>

<div class="row">
<label>Speed <span id="spv"></span></label>
<input type="range" id="speed" min=".5" max="2" step=".01" value="1">
</div>

<div class="buttons">
<button class="primary" onclick="play()">Play</button>
<button class="secondary" onclick="stop()">Stop</button>
<button class="secondary" onclick="addSeg()">Add Section</button>
<button class="secondary" onclick="adv()">Advanced</button>
<button class="primary" onclick="download()">Download</button>
</div>
</div>

<div class="panel advanced" id="advanced">
<h1>Sections</h1>
<div id="segments"></div>
</div>

</div>

<div class="dialog" id="dialog">
<div class="box" id="dialogBox"></div>
</div>

<script>
let ctx,buffer,src;
let segments=[];
let audioData=null;

const file=document.getElementById("file");
const editor=document.getElementById("editor");
const advPanel=document.getElementById("advanced");

const start=document.getElementById("start");
const end=document.getElementById("end");
const speed=document.getElementById("speed");
const sv=document.getElementById("sv");
const ev=document.getElementById("ev");
const spv=document.getElementById("spv");

[file,start,end,speed].forEach(i=>i.oninput=upd);

function upd(){
sv.textContent=(+start.value).toFixed(2)+"s";
ev.textContent=(+end.value).toFixed(2)+"s";
spv.textContent=(+speed.value).toFixed(2)+"×";
}

function stop(){if(src){src.stop();src=null}}

function play(){
stop();
src=ctx.createBufferSource();
src.buffer=buffer;
src.playbackRate.value=speed.value;
src.connect(ctx.destination);
src.start(0,start.value,end.value-start.value);
}

file.onchange=async e=>{
if(buffer){importDialog(e.target.files[0]);return}
loadFile(e.target.files[0])
}

async function loadFile(f){
ctx=new AudioContext();
audioData=await f.arrayBuffer();
buffer=await ctx.decodeAudioData(audioData.slice(0));
start.max=end.max=buffer.duration;
end.value=buffer.duration;
upd();
editor.style.display="block";
}

function importDialog(newFile){
showDialog([
["Switch audio",()=>{clearProject();loadFile(newFile)}],
["Switch but save current",()=>{saveProject();clearProject();loadFile(newFile)}],
["Save and close this menu",()=>{saveProject();closeDialog()}],
["Close menu",closeDialog]
])
}

function addSeg(){
segments.push({start:+start.value,end:+end.value,fade:0,mode:"after",min:false});
render();
}

function render(){
const c=document.getElementById("segments");
c.innerHTML="";
segments.forEach((s,i)=>{
const d=document.createElement("div");
d.className="segment"+(s.min?" min":"");
d.innerHTML=`
<header>
<b>Section ${i+1}</b>
<div>
<button class="secondary" onclick="segments[${i}].min=!segments[${i}].min;render()">▾</button>
<button class="secondary" onclick="segments.splice(${i},1);render()">✕</button>
</div>
</header>
<div class="body">
<small>${s.start.toFixed(2)}s → ${s.end.toFixed(2)}s</small><br>
<select onchange="segments[${i}].mode=this.value">
<option value="after">After</option>
<option value="cross">Crossfade</option>
</select>
<input type="range" min="0" max="3" step=".05" value="${s.fade}"
oninput="segments[${i}].fade=this.value">
</div>`;
c.appendChild(d);
})
}

function adv(){advPanel.style.display=advPanel.style.display?"":"block"}

function saveProject(){
if(!audioData)return;
const id=Date.now();
localStorage.setItem("save-"+id,JSON.stringify({
audio:Array.from(new Uint8Array(audioData)),
segments
}));
}

function openLoad(){
const keys=Object.keys(localStorage).filter(k=>k.startsWith("save-"));
if(buffer){
showDialog([
["Load anyway",()=>{loadSave(keys[0])}],
["Cancel",closeDialog]
]);
}else loadSave(keys[0]);
}

async function loadSave(k){
const s=JSON.parse(localStorage.getItem(k));
ctx=new AudioContext();
audioData=new Uint8Array(s.audio).buffer;
buffer=await ctx.decodeAudioData(audioData.slice(0));
segments=s.segments;
start.max=end.max=buffer.duration;
end.value=buffer.duration;
upd();
editor.style.display="block";
render();
closeDialog();
}

function download(){
if(!segments.length)return;
let len=0;
segments.forEach((s,i)=>{len+=s.end-s.start;if(i&&s.mode==="cross")len-=s.fade});
const off=new OfflineAudioContext(buffer.numberOfChannels,len*buffer.sampleRate,buffer.sampleRate);
let t=0;
segments.forEach((s,i)=>{
const src=off.createBufferSource();
const g=off.createGain();
src.buffer=buffer;
src.connect(g).connect(off.destination);
if(i&&s.mode==="cross"){g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(1,t+s.fade);t-=s.fade}
src.start(t,s.start,s.end-s.start);
t+=s.end-s.start;
});
off.startRendering().then(r=>{
const a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([encode(r)],{type:"audio/wav"}));
a.download="final.wav";
a.click();
})
}

function encode(b){
const l=b.length*2*b.numberOfChannels+44;
const v=new DataView(new ArrayBuffer(l));
let o=0;
const w=s=>{for(let i=0;i<s.length;i++)v.setUint8(o++,s.charCodeAt(i))};
const u16=d=>{v.setUint16(o,d,true);o+=2};
const u32=d=>{v.setUint32(o,d,true);o+=4};
w("RIFF");u32(l-8);w("WAVEfmt ");u32(16);u16(1);
u16(b.numberOfChannels);u32(b.sampleRate);
u32(b.sampleRate*b.numberOfChannels*2);
u16(b.numberOfChannels*2);u16(16);w("data");u32(l-o-4);
for(let i=0;i<b.length;i++)
for(let c=0;c<b.numberOfChannels;c++){
let s=b.getChannelData(c)[i];
v.setInt16(o,Math.max(-1,Math.min(1,s))*32767,true);o+=2
}
return v.buffer
}

function toggleSide(){document.getElementById("side").classList.toggle("open")}

function showDialog(opts){
const d=document.getElementById("dialog");
const b=document.getElementById("dialogBox");
b.innerHTML="";
opts.forEach(o=>{
const btn=document.createElement("button");
btn.className="secondary";
btn.textContent=o[0];
btn.onclick=o[1];
b.appendChild(btn);
});
d.style.display="flex";
}

function closeDialog(){document.getElementById("dialog").style.display="none"}

function clearProject(){
stop();
buffer=null;
segments=[];
editor.style.display="none";
advPanel.style.display="none";
}
</script>
</body>
</html>
