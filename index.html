<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Audio Editor</title>
<style>
:root {
    --bg: radial-gradient(circle at top, #1c1c1c, #000);
    --gold: #d4af37;
    --panel: rgba(18,18,18,0.95);
    --text: #f3f3f3;
    --muted: #9a9a9a;
}
* { box-sizing: border-box; }
body {
    margin: 0;
    min-height: 100vh;
    background: var(--bg);
    font-family: system-ui, sans-serif;
    color: var(--text);
}
.wrapper {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px;
}
.panel {
    background: var(--panel);
    border: 1px solid rgba(212,175,55,0.25);
    border-radius: 18px;
    padding: 28px;
    margin-bottom: 28px;
}
h1 {
    margin: 0 0 20px;
    color: var(--gold);
    text-align: center;
}
.import {
    border: 2px dashed rgba(212,175,55,0.35);
    padding: 50px;
    border-radius: 14px;
    text-align: center;
    cursor: pointer;
}
.import input { display: none; }
.controls, .advanced { display: none; }
.row {
    margin-bottom: 18px;
}
label {
    font-size: 14px;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
}
input[type=range] {
    width: 100%;
}
.buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}
button {
    padding: 14px;
    border-radius: 12px;
    border: none;
    font-weight: 600;
    cursor: pointer;
}
.primary {
    background: linear-gradient(135deg,#b8962e,#f0d57a);
    color: #000;
}
.secondary {
    background: transparent;
    border: 1px solid rgba(212,175,55,0.35);
    color: var(--gold);
}
.segment {
    border: 1px solid rgba(212,175,55,0.35);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 14px;
}
.segment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
    gap: 12px;
}
.segment small {
    color: var(--muted);
}
select {
    background: #000;
    color: var(--text);
    border: 1px solid rgba(212,175,55,0.3);
    border-radius: 6px;
    padding: 6px;
}
</style>
</head>
<body>

<div class="wrapper">

<div class="panel">
    <h1>Import File</h1>
    <label class="import">
        <input type="file" id="file" accept="audio/*">
        Click to import audio
    </label>
</div>

<div class="panel controls" id="editor">
    <h1>Editor</h1>

    <div class="row">
        <label>Start <span id="startVal">0.00s</span></label>
        <input type="range" id="start" step="0.01">
    </div>

    <div class="row">
        <label>End <span id="endVal">0.00s</span></label>
        <input type="range" id="end" step="0.01">
    </div>

    <div class="row">
        <label>Playback Speed <span id="speedVal">1.00×</span></label>
        <input type="range" id="speed" min="0.5" max="2" step="0.01" value="1">
    </div>

    <div class="buttons">
        <button class="primary" id="play">Play</button>
        <button class="secondary" id="stop">Stop</button>
        <button class="secondary" id="add">Add Section</button>
        <button class="secondary" id="toggle">Advanced</button>
        <button class="primary" id="download">Download</button>
    </div>
</div>

<div class="panel advanced" id="advanced">
    <h1>Sections</h1>
    <div id="segments"></div>
</div>

</div>

<script>
let ctx, buffer, src;
let segments = [];

const file = document.getElementById("file");
const editor = document.getElementById("editor");
const advanced = document.getElementById("advanced");

const start = document.getElementById("start");
const end = document.getElementById("end");
const speed = document.getElementById("speed");

const startVal = document.getElementById("startVal");
const endVal = document.getElementById("endVal");
const speedVal = document.getElementById("speedVal");

file.onchange = async e => {
    ctx = new AudioContext();
    buffer = await ctx.decodeAudioData(await e.target.files[0].arrayBuffer());
    start.max = end.max = buffer.duration;
    end.value = buffer.duration;
    updateVals();
    editor.style.display = "block";
};

function updateVals() {
    startVal.textContent = (+start.value).toFixed(2) + "s";
    endVal.textContent = (+end.value).toFixed(2) + "s";
    speedVal.textContent = (+speed.value).toFixed(2) + "×";
}

[start,end,speed].forEach(i=>i.oninput=updateVals);

function stop() {
    if (src) {
        src.stop();
        src.disconnect();
        src = null;
    }
}

document.getElementById("play").onclick = () => {
    stop();
    src = ctx.createBufferSource();
    src.buffer = buffer;
    src.playbackRate.value = speed.value;
    src.connect(ctx.destination);
    src.start(0, start.value, end.value - start.value);
};

document.getElementById("stop").onclick = stop;

document.getElementById("add").onclick = () => {
    segments.push({
        start:+start.value,
        end:+end.value,
        fade:+0,
        mode:"after"
    });
    renderSegments();
};

document.getElementById("toggle").onclick = () => {
    advanced.style.display = advanced.style.display==="block"?"none":"block";
};

function renderSegments() {
    const c = document.getElementById("segments");
    c.innerHTML = "";
    segments.forEach((s,i)=>{
        const d=document.createElement("div");
        d.className="segment";
        d.innerHTML=`
        <strong>Section ${i+1}</strong>
        <div class="segment-grid">
            <small>Start ${s.start.toFixed(2)}s</small>
            <small>End ${s.end.toFixed(2)}s</small>
            <div>
                <small>Placement</small><br>
                <select onchange="segments[${i}].mode=this.value">
                    <option value="after" ${s.mode==="after"?"selected":""}>After</option>
                    <option value="cross" ${s.mode==="cross"?"selected":""}>Crossfade</option>
                </select>
            </div>
            <div>
                <small>Fade (s)</small><br>
                <input type="range" min="0" max="3" step="0.05" value="${s.fade}"
                 oninput="segments[${i}].fade=this.value">
            </div>
        </div>
        `;
        c.appendChild(d);
    });
}

document.getElementById("download").onclick = async () => {
    if (!segments.length) return;
    let length = 0;
    segments.forEach((s,i)=>{
        length += s.end - s.start;
        if (i && s.mode==="cross") length -= s.fade;
    });
    const off = new OfflineAudioContext(buffer.numberOfChannels, length*buffer.sampleRate, buffer.sampleRate);
    let t=0;
    segments.forEach((s,i)=>{
        const src=off.createBufferSource();
        const gain=off.createGain();
        src.buffer=buffer;
        src.connect(gain).connect(off.destination);
        if (i && s.mode==="cross") {
            gain.gain.setValueAtTime(0,t);
            gain.gain.linearRampToValueAtTime(1,t+s.fade);
            t-=s.fade;
        }
        src.start(t,s.start,s.end-s.start);
        t+=s.end-s.start;
    });
    const r=await off.startRendering();
    const wav=encode(r);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([wav],{type:"audio/wav"}));
    a.download="final.wav";
    a.click();
};

function encode(b){
    const l=b.length*2*b.numberOfChannels+44;
    const v=new DataView(new ArrayBuffer(l));
    let o=0;
    const w=s=>{for(let i=0;i<s.length;i++)v.setUint8(o++,s.charCodeAt(i));};
    const u16=d=>{v.setUint16(o,d,true);o+=2;};
    const u32=d=>{v.setUint32(o,d,true);o+=4;};
    w("RIFF");u32(l-8);w("WAVEfmt ");u32(16);u16(1);
    u16(b.numberOfChannels);u32(b.sampleRate);
    u32(b.sampleRate*b.numberOfChannels*2);
    u16(b.numberOfChannels*2);u16(16);w("data");u32(l-o-4);
    for(let i=0;i<b.length;i++)
        for(let c=0;c<b.numberOfChannels;c++){
            let s=b.getChannelData(c)[i];
            s=Math.max(-1,Math.min(1,s));
            v.setInt16(o,s*32767,true);o+=2;
        }
    return v.buffer;
}
</script>
</body>
</html>
